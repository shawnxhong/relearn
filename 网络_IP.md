# IP
IP 协议是 无连接/不可靠， 尽力而为的服务， 主要作用：
- 寻址和路由
  - IP 数据包里，携带source ip, dest ip
  - 中间节点路由器/IP网关， 根据地址进行转发，检查路由器表
- 分段与重组
  - IP数据包在传输过程中，会经过不同的路径
  - 不同的网络中，数据包的最大长度限制是不同的
  - IP协议给每个数据包，分配一个标识符， 分段与组装的信息
  - 使数据包被拆开之后也能原样装回去
  - 到达dest主机后，能恢复出原来的ip数据包

## IP地址的分类
- IP地址是指互联网协议地址，是IP协议提供的一种统一的地址格式
- 为互联网上的每一个网络和每一台主机分配一个逻辑地址，以此来屏蔽物理地址的差异。
- IP地址编址方案将IP地址空间划分为A、B、C、D、E五类
- 其中A、B、C是基本类
- D、E类作为多播和保留使用，为特殊地址。
- 每个IP地址包括两个标识码（ID），即网络ID和主机ID
- 同一个物理网络上的所有主机都使用同一个网络ID
- 网络上的一个主机（包括网络上工作站，服务器和路由器等）有一个主机ID与其对应
- A~E类地址的特点如下：
  - A类地址：以0开头，第一个字节范围：0~127；
  - B类地址：以10开头，第一个字节范围：128~191；
  - C类地址：以110开头，第一个字节范围：192~223；
  - D类地址：以1110开头，第一个字节范围为224~239；
  - E类地址：以1111开头，保留地址

### A类地址
- 第一段号码为网络号码                  1字节   8位
- 剩下的三段号码为本地计算机的号码        3字节   24位
- 网络地址的最高位必须是“0”
- A类网络地址数量较少，有126个网络， 每个网络容纳主机数 == 1600多万台。
- A类IP地址的地址范围1.0.0.0到127.255.255.255
- 最后一个是广播地址。A类IP地址的子网掩码为255.0.0.0

### B类地址
- 前两段号码为网络号码      2字节   16位
- 后两段为主机地址         2字节   16位
- 网络地址的最高位必须是“10”
- B类网络地址适用于中等规模的网络
  - 有16384个网络
  - 每个网络主机数 256*25 == 65536。

- B类IP地址地址范围128.0.0.0-191.255.255.255
- 最后一个是广播地址。B类IP地址的子网掩码为255.255.0.0。


### C类地址
- 前三段号码为网络号码                  3字节   24位
- 剩下的一段号码为本地计算机的号码。      1字节    8位
- 网络地址的最高位必须是 110
- C类网络地址数量较多
  - 有209万余个网络
  - 每个网络最多只能包含254台计算机。

- C类IP地址范围192.0.0.0-223.255.255.255
- C类IP地址的子网掩码为255.255.255.0，每个网络支持的最大主机数为256-2=254台。

### D类地址
- 多播地址，用于1对多通信，最高位必须是“1110”
- D类IP地址在历史上被叫做多播地址(multicast address)，即组播地址。
- 在以太网中，多播地址命名了一组应该在这个网络中应用接收到一个分组的站点。
- 多播地址的最高位必须是“1110”，范围从224.0.0.0到239.255.255.255。


## ipv4 地址不够怎么办
- DHCP
  - 动态主机配置协议
  - 动态分配IP地址，只给接入网络的设备分配ip地址
  - 同一个mac地址的设备，每次入网的ip都不同
- IPv6
  - 2 ^ 128 次放
  - 肯定够


## 路由器分组流程
1. 从IP数据包中， 提取出 dest IP
2. 判断dest IP 是否与本路由器直连， 直连就交付，不行下一步
3. 检查路由器表中 是否有 dest IP 指定的主机路由，有的话直接给指定好的人，没有下一步
4. 逐条检查路由器表，找得到匹配路由，就按表转发
5. 若路由表中，设置有默认路由，则转发给默认路由
6. 实在找不到， 向 source IP 报错


## ARP
- ARP == address resolution protocol
- 地址解析协议
- 根据 IP 地址，获取 mac 地址
- 局域网中，两台主机通信 依靠mac 地址， 但发送方 只知道 IP 地址，所以要ARP
1. 每个主机，在自己的ARP 缓冲区，建立 ARP 列表，记录 IP <-> MAC关系
2. 源主机发包时 先检查ARP 是否有 对面的 MAC, 有就直接发
   没有，就向子网内的所有人， 发送ARP包
   内容 source IP + MAC, dest IP
3. 子网内的人接受到ARP包时
   首先检查 dest 是不是自己 不是就忽略
   如果是自己 先把 source IP + MAC 加入 ARP列表
   把自己的 MAC 写入响应包，发给source
4. source 收到响应包
   把 dest IP + MAC 写入 ARP, 之后都这么发
   没收到响应包，说明ARP查询失败


## MAC 和 IP 的区别
- MAC 是写在网卡上的物理地址，不会变的唯一的，定义网络设备的位置
- IP 地址是网络层 和 以上各层使用的地址，是逻辑地址。用来区别网络上的计算机


## 如果只有MAC地址
- 需要路由器 记住每个MAC地址 属于哪个子网
- 否则每次路由器都要全世界ARP 寻找MAC地址
- 有了IP地址之后
  - 同一个子网的设备的 IP 前缀都一样
  - 根据IP 地址，先弄到子网
  - 剩下子网内部传送
- 当设备联入网络时， 根据所在子网，动态分配 IP地址
  - 设备没入网时，只有MAC物理地址


## ICMP 和 ping
- ICMP  == internet control message protocol
- 用来ping 的
- ping 不通怎么办
  - 看看网连上没，网卡驱动对不对
  - 局域网 设置对不对
  - 是不是防火墙拦了
  - 是不是第三方软件拦了


## TTL 是啥
- 生存时间
- 每个包都有个最大转发次数，每被转发一次 减一
- 减到0 丢弃
- 防止出现在一个环里打圈出不去的情况
